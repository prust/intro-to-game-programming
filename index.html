<canvas id="canvas"></canvas>
<script>
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
canvas.width = document.body.clientWidth;
canvas.height = document.body.clientHeight;
document.body.style.margin = 0;

var player = {
  x: canvas.width / 2,
  y: canvas.height / 2,
  dx: 0,
  dy: 0,
  w: 20,
  h: 20
};

var bullets = [];
var enemies = [
  {x: 50, y: 50, dx: 0, dy: 0, w: 20, h: 20},
  {x: canvas.width - 50, y: 50, dx: 0, dy: 0, w: 20, h: 20},
  {x: 50, y: canvas.height - 50, dx: 0, dy: 0, w: 20, h: 20},
  {x: canvas.width - 50, y: canvas.height - 50, dx: 0, dy: 0, w: 20, h: 20}
];

var left = 37;
var right = 39;
var up = 38;
var down = 40;
var w_key = 87;
var a_key = 65;
var s_key = 83;
var d_key = 68;

var is_left_down = false;
var is_right_down = false;
var is_up_down = false;
var is_down_down = false;

document.addEventListener('keydown', function(event) {
  if (event.keyCode == left || event.keyCode == a_key)
    is_left_down = true;
  else if (event.keyCode == right || event.keyCode == d_key)
    is_right_down = true;

  if (event.keyCode == up || event.keyCode == w_key)
    is_up_down = true;
  else if (event.keyCode == down || event.keyCode == s_key)
    is_down_down = true;
});

document.addEventListener('keyup', function(event) {
  if (event.keyCode == left || event.keyCode == a_key)
    is_left_down = false;
  else if (event.keyCode == right || event.keyCode == d_key)
    is_right_down = false;

  if (event.keyCode == up || event.keyCode == w_key)
    is_up_down = false;
  else if (event.keyCode == down || event.keyCode == s_key)
    is_down_down = false;
});

document.addEventListener('click', function(event) {
  var bullet = {
  	x: player.x,
  	y: player.y,
  	dx: (event.clientX - player.x) / 30,
  	dy: (event.clientY - player.y) / 30,
    w: 5,
    h: 5
  };
  bullets.push(bullet);
});

function update() {
  var max_speed = 10;
  var thrust_accel = 0.8;
  var coast_decel = 0.2;

  // horizontal movement
  if (is_left_down)
    player.dx = player.dx - thrust_accel;
  else if (player.dx < 0)
    player.dx = player.dx + coast_decel;

  if (is_right_down)
    player.dx = player.dx + thrust_accel;
  else if (player.dx > 0)
    player.dx = player.dx - coast_decel;


  if (player.dx > max_speed)
    player.dx = max_speed;
  else if (player.dx < -max_speed)
    player.dx = -max_speed;

  player.x = player.x + player.dx;

  // vertical movement
  if (is_up_down)
    player.dy = player.dy - thrust_accel;
  else if (player.dy < 0)
    player.dy = player.dy + coast_decel;

  if (is_down_down)
    player.dy = player.dy + thrust_accel;
  else if (player.dy > 0)
    player.dy = player.dy - coast_decel;

  if (player.dy > max_speed)
    player.dy = max_speed;
  else if (player.dy < -max_speed)
    player.dy = -max_speed;

  player.y = player.y + player.dy;

  var bullet_indexes_to_destroy = [];
  for (var i = 0; i < bullets.length; i++) {
    var bullet = bullets[i];
    bullet.x = bullet.x + bullet.dx;
    bullet.y = bullet.y + bullet.dy;
    
    var is_offscreen = bullet.x < 0 || bullet.y < 0 ||
      bullet.x > canvas.width || bullet.y > canvas.height;
    
    if (is_offscreen) {
      bullet_indexes_to_destroy.push(i);
    }
    // avoid hitting enemy w/ bullet we're destroying, so it doesn't get in array twice
    else {
      var hit_enemy_ix = null;
      for (var k = 0; k < enemies.length; k++) {
        var enemy = enemies[k];
        if (collides(enemy, bullet))
          hit_enemy_ix = k;
      }
      if (hit_enemy_ix != null) {
        bullet_indexes_to_destroy.push(i);
        enemies.splice(hit_enemy_ix, 1);
      }
    }
  }

  bullet_indexes_to_destroy.reverse();
  for (var i = 0; i < bullet_indexes_to_destroy.length; i++) {
    var index = bullet_indexes_to_destroy[i];
    bullets.splice(index, 1);
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // draw player
  ctx.fillStyle = 'blue';
  drawEntity(player, ctx);
  
  // draw bullets
  ctx.fillStyle = 'red';
  for (var i = 0; i < bullets.length; i++)
    drawEntity(bullets[i], ctx);

  // draw enemies
  ctx.fillStyle = 'green';
  for (var i = 0; i < enemies.length; i++)
    drawEntity(enemies[i], ctx);

  requestAnimationFrame(update);
}

requestAnimationFrame(update);

function drawEntity(ent, ctx) {
  ctx.fillRect(ent.x, ent.y, ent.w, ent.h);
}

// determines if the two objects overlap
function collides(obj1, obj2) {
  // calculate the x/y coordinates of the bottom-right corner for obj1
  var obj1_x2 = obj1.x + obj1.w;
  var obj1_y2 = obj1.y + obj1.h;

  // calculate the x/y coordinates of the bottom-right corner for obj2
  var obj2_x2 = obj2.x + obj2.w;
  var obj2_y2 = obj2.y + obj2.h;

  return obj1_x2 > obj2.x && obj1.x < obj2_x2 && // x-dimension overlap
        obj1_y2 > obj2.y && obj1.y < obj2_y2; // y-dimension overlap
}

</script>
